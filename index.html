<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>📚 ห้องสมุดน่ารัก</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body class="bg-gradient-to-r from-green-200 via-purple-200 to-blue-200 min-h-screen flex flex-col items-center p-6">
  <h1 class="text-3xl font-bold text-purple-700 mb-6">📚 ห้องสมุดน่ารัก</h1>

  <!-- เมนูเลือกฟังก์ชัน -->
  <div class="grid grid-cols-2 gap-4 mb-8">
    <button onclick="showSection('borrow')" class="bg-green-400 hover:bg-green-500 text-white px-4 py-2 rounded-2xl shadow">ยืม-คืน</button>
    <button onclick="showSection('addBook')" class="bg-blue-400 hover:bg-blue-500 text-white px-4 py-2 rounded-2xl shadow">เพิ่มหนังสือ</button>
    <button onclick="showSection('stats')" class="bg-purple-400 hover:bg-purple-500 text-white px-4 py-2 rounded-2xl shadow">สถิติ</button>
    <button onclick="showSection('helper')" class="bg-pink-400 hover:bg-pink-500 text-white px-4 py-2 rounded-2xl shadow">ผู้ช่วย</button>
  </div>

  <!-- 🔹 Section ยืม-คืน -->
  <div id="borrow" class="hidden w-full max-w-md bg-white p-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-bold text-green-600 mb-4">📖 ยืม-คืน หนังสือ</h2>

    <button onclick="startScanner()" class="bg-green-500 text-white px-4 py-2 rounded-lg">📷 สแกน QR Code</button>
    <div id="reader" style="width: 300px; display:none; margin-top:10px;"></div>
    <div id="scan-result" class="mt-2 text-blue-600 font-bold"></div>

    <form id="borrowForm" class="mt-4 space-y-2">
      <input id="studentId" class="w-full border p-2 rounded" placeholder="เลขประจำตัวนักเรียน" required>
      <input id="studentName" class="w-full border p-2 rounded" placeholder="ชื่อนักเรียน" required>
      <input id="bookName" class="w-full border p-2 rounded" placeholder="ชื่อหนังสือ" required>
      <input id="author" class="w-full border p-2 rounded" placeholder="ผู้แต่ง" required>
      <input id="category" class="w-full border p-2 rounded" placeholder="หมวดหมู่ดิวอี้" required>
      <input id="publisher" class="w-full border p-2 rounded" placeholder="สำนักพิมพ์" required>
      <input id="year" class="w-full border p-2 rounded" placeholder="ปีที่พิมพ์" required>
      <input id="bookCode" class="w-full border p-2 rounded" placeholder="รหัสหนังสือ" required>
      <select id="actionType" class="w-full border p-2 rounded" required>
        <option value="">--เลือกการทำรายการ--</option>
        <option value="ยืม">ยืม</option>
        <option value="คืน">คืน</option>
      </select>
      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-lg">บันทึก</button>
    </form>
  </div>

  <!-- 🔹 Section เพิ่มหนังสือ -->
  <div id="addBook" class="hidden w-full max-w-md bg-white p-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-bold text-blue-600 mb-4">➕ เพิ่มหนังสือ</h2>
    <form id="addBookForm" class="space-y-2">
      <input id="newBookName" class="w-full border p-2 rounded" placeholder="ชื่อหนังสือ" required>
      <input id="newAuthor" class="w-full border p-2 rounded" placeholder="ผู้แต่ง" required>
      <input id="newCategory" class="w-full border p-2 rounded" placeholder="หมวดหมู่ดิวอี้" required>
      <input id="newPublisher" class="w-full border p-2 rounded" placeholder="สำนักพิมพ์" required>
      <input id="newYear" class="w-full border p-2 rounded" placeholder="ปีที่พิมพ์" required>
      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-lg">บันทึก</button>
    </form>
  </div>

  <!-- 🔹 Section สถิติ -->
  <div id="stats" class="hidden w-full max-w-md bg-white p-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-bold text-purple-600 mb-4">📊 สถิติ</h2>
    <button onclick="recordLibraryEntry('เข้า')" class="w-full bg-green-400 text-white p-2 rounded-lg mb-2">นักเรียนเข้า</button>
    <button onclick="recordLibraryEntry('ออก')" class="w-full bg-red-400 text-white p-2 rounded-lg">นักเรียนออก</button>
  </div>

  <!-- 🔹 Section ผู้ช่วย -->
  <div id="helper" class="hidden w-full max-w-md bg-white p-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-bold text-pink-600 mb-4">👩‍💼 ผู้ช่วยบรรณารักษ์</h2>
    <form id="helperForm" class="space-y-2">
      <input id="helperName" class="w-full border p-2 rounded" placeholder="ชื่อผู้ช่วย" required>
      <select id="helperTask" class="w-full border p-2 rounded" required>
        <option value="">--เลือกงาน--</option>
        <option>กวาดพื้น</option>
        <option>ถูพื้น</option>
        <option>จัดเก็บหนังสือ</option>
        <option>เช็ดโต๊ะ</option>
        <option>บริการการยืม-คืนหนังสือ</option>
        <option>เช็ดชั้นหนังสือ</option>
      </select>
      <button type="submit" class="w-full bg-pink-500 text-white p-2 rounded-lg">บันทึก</button>
    </form>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwHvkscbEsYHasAueGHHrqP-j26bwiAYryAm23AYTrnQewytXtj1_xWAeavWc3Yl6oIw/exec";

// 📌 สลับเมนู
function showSection(id) {
  document.querySelectorAll("div[id]").forEach(div => div.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

// 📌 ยืม-คืนหนังสือ
document.getElementById("borrowForm").addEventListener("submit", function(e) {
  e.preventDefault();
  let data = {
    action: "borrow",
    studentId: studentId.value,
    studentName: studentName.value,
    bookName: bookName.value,
    author: author.value,
    category: category.value,
    publisher: publisher.value,
    year: year.value,
    bookCode: bookCode.value,
    actionType: actionType.value
  };
  Swal.fire({title:"กำลังบันทึก...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
  fetch(API_URL+"?"+new URLSearchParams(data))
  .then(r=>r.json()).then(res=>{
    Swal.fire("สำเร็จ","บันทึกข้อมูลเรียบร้อย ✅","success");
    e.target.reset();
  });
});

// 📌 เพิ่มหนังสือ
document.getElementById("addBookForm").addEventListener("submit", function(e) {
  e.preventDefault();
  let data = {
    action: "addBook",
    bookName: newBookName.value,
    author: newAuthor.value,
    category: newCategory.value,
    publisher: newPublisher.value,
    year: newYear.value
  };
  Swal.fire({title:"กำลังบันทึก...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
  fetch(API_URL+"?"+new URLSearchParams(data))
  .then(r=>r.json()).then(res=>{
    Swal.fire("สำเร็จ","เพิ่มหนังสือเรียบร้อย ✅","success");
    e.target.reset();
  });
});

// 📌 สถิติเข้าออก
function recordLibraryEntry(type) {
  Swal.fire({title:"กำลังบันทึก...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
  fetch(API_URL+"?action=entry&type="+type)
  .then(r=>r.json()).then(res=>{
    Swal.fire("สำเร็จ",`บันทึกการ${type}เรียบร้อย ✅`,"success");
  });
}

// 📌 ผู้ช่วย
document.getElementById("helperForm").addEventListener("submit", function(e) {
  e.preventDefault();
  let data = {
    action: "helper",
    helperName: helperName.value,
    task: helperTask.value
  };
  Swal.fire({title:"กำลังบันทึก...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
  fetch(API_URL+"?"+new URLSearchParams(data))
  .then(r=>r.json()).then(res=>{
    Swal.fire("สำเร็จ","บันทึกงานผู้ช่วยเรียบร้อย ✅","success");
    e.target.reset();
  });
});

// 📌 QR Code Scanner
let html5QrCode;
function startScanner() {
  document.getElementById("reader").style.display="block";
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    (decodedText) => {
      document.getElementById("scan-result").innerText = "📖 กำลังค้นหา: " + decodedText;
      fetch(API_URL+"?action=getBook&code="+decodedText)
      .then(r=>r.json()).then(data=>{
        if(data.success){
          bookName.value=data.bookName;
          author.value=data.author;
          category.value=data.category;
          publisher.value=data.publisher;
          year.value=data.year;
          bookCode.value=data.bookCode;
          document.getElementById("scan-result").innerText="✅ พบหนังสือ: "+data.bookName;
          html5QrCode.stop();
        } else {
          document.getElementById("scan-result").innerText="❌ ไม่พบบันทึกหนังสือ";
        }
      });
    },
    ()=>{}
  );
}
</script>
</body>
</html>
